# Performance | React Native Docs

## [パフォーマンスの概要](https://reactnative.dev/docs/performance)

React Native では「開発者メニュー」で「Show Perf Monitor」をタッチし、パフォーマンスのモニタリングを有効にすることが可能。アプリにオーバーレイする形でパフォーマンスが表示される。

### FPS

パフォーマンスモニタを有効にすると、２種類の FPS が表示されている。

#### JS frame rate (JavaScript スレッド)

JavaScript スレッドにおけるフレームレート。ほとんどの React Native アプリにおいて、ビジネスロジックは JavaScript スレッドで実行される。JavaScript スレッドが１フレームの間応答しない場合、ネイティブ側でそのフレームはドロップされたものとみなされる。

例えば、複雑なアプリのルートコンポーネントでステートを更新し、計算量の多いコンポーネントツリーの再レンダリングを行った場合を考えてみる。仮に再レンダリングに 200ms 要したとすると、12 フレームがドロップされることになる。その間、JavaScript で制御しているアニメーションはフリーズしているように見えてしまう。

これはナビゲーションの移行時によく起こる。新しいルートをプッシュした時、JavaScript スレッドはシーンに必要なすべてのコンポーネントをレンダリングし、バックビューを作成するためにネイティブ側に適切なコマンドを送信する必要がある。ここでの処理には数フレーム要するのが一般的。また、コンポーネントが`componentDidMount`で追加で処理をするケースもあり、ナビゲーションの際に２回フリーズが発生してしまう可能性がある。

もう１つの例として、タッチの応答が挙げられる。JavaScript スレッドが複数のフレームにまたがって処理をしている場合、たとえば`TouchableOpacity`への応答が遅れることがある。これは、JavaScript スレッドが多忙でメインスレッドが送られてきたタッチイベントを処理できないため。その結果、`TouchableOpacity`はタッチイベントに反応できず、ネイティブビューに不透明度の調整を指示できない。

#### UI frame rate (メインスレッド)

ネイティブ側のメインスレッドにおけるフレームレート。例えば、`Animated`の`useNativeDriver`設定で考えてみる。`useNativeDriver`を`有効(true)`にすることで、ネイティブ側にすべてのアニメーション情報を送信し、アニメーション開始以降はブリッジを介さずメインスレッドでアニメーションを制御をする。それにより、JavaScript スレッドでのフレームドロップが発生しなくなる。もし、JavaScript スレッドが多忙だったとしても、既に開始したアニメーションへの影響はない。

同様に、ScrollView はメインスレッド上に存在するため、JavaScript スレッドに疎外されることなく上下にスクロールできる。

## パフォーマンス問題の主な原因

### 開発モードでの実行

開発モードで実行すると、JavaScript スレッドのパフォーマンスが大きく低下する。これは、propsType の検証や様々なアサーションなど、適切な警告やエラーメッセージを提供するためのトレードオフ。パフォーマンス検証は必ずリリースビルドした成果物で行うこと。

### console.log の使用

console.log は JavaScript スレッドで大きなボトルネックになる可能性がある。`redux-logger`のようなデバッグライブラリからの呼び出しも含まれるため、バンドルする前に削除する必要がある。これは、以下のように babel プラグインを利用することでも解決可能。

- babel プラグインのインストール

  ```shell
  npm i -D babel-plugin-transform-remove-console
  ```

- babel プラグインの設定

  プロジェクトディレクトリの`.babelrc`を編集。

  ```json
  {
    "env": {
      "production": {
        "plugins": ["transform-remove-console"]
      }
    }
  }
  ```

これにより、プロジェクトのリリースバージョンでは、すべての`console.*`呼び出しが自動的に削除される。
